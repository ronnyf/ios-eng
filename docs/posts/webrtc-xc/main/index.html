<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Building WebRTC for iOS/macOS with Xcode | iOS Engineering</title>
<meta name="keywords" content="WebRTC, Xcode">
<meta name="description" content="Introduction WebRTC (Web Real-Time Communication) is a powerful open-source technology that enables real-time communication capabilities in web and mobile applications. While WebRTC is well-supported in web browsers, incorporating it into iOS applications often requires (re)building a binary framework to ensure seamless integration and improved performance. In this article, we will provide a comprehensive step-by-step guide on how to integrate WebRTC into any iOS/macOS application and building it from source entirely in Xcode.">
<meta name="author" content="">
<link rel="canonical" href="https://www.rfxsoftware.com/posts/webrtc-xc/main/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.d13dc9670c54a799901d8f51eb366234127600b84f76504283993a1e6bb2ffd7.css" integrity="sha256-0T3JZwxUp5mQHY9R6zZiNBJ2ALhPdlBCg5k6Hmuy/9c=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://www.rfxsoftware.com/favicon.ico">
<link rel="apple-touch-icon" href="https://www.rfxsoftware.com/apple-touch-icon.png">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-4FC8CCB4QQ"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-4FC8CCB4QQ', { 'anonymize_ip': false });
}
</script>

<meta name="twitter:title" content="Building WebRTC for iOS/macOS with Xcode | iOS Engineering" />
<meta name="twitter:description" content="Introduction WebRTC (Web Real-Time Communication) is a powerful open-source technology that enables real-time communication capabilities in web and mobile applications. While WebRTC is well-supported in web browsers, incorporating it into iOS applications often requires (re)building a binary framework to ensure seamless integration and improved performance. In this article, we will provide a comprehensive step-by-step guide on how to integrate WebRTC into any iOS/macOS application and building it from source entirely in Xcode." />
<meta property="og:title" content="Building WebRTC for iOS/macOS with Xcode | iOS Engineering" />
<meta property="og:description" content="Introduction WebRTC (Web Real-Time Communication) is a powerful open-source technology that enables real-time communication capabilities in web and mobile applications. While WebRTC is well-supported in web browsers, incorporating it into iOS applications often requires (re)building a binary framework to ensure seamless integration and improved performance. In this article, we will provide a comprehensive step-by-step guide on how to integrate WebRTC into any iOS/macOS application and building it from source entirely in Xcode." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.rfxsoftware.com/posts/webrtc-xc/main/" />
<meta property="article:section" content="posts" />
  <meta property="article:published_time" content="2023-08-20T18:00:00-07:00" />
  <meta property="article:modified_time" content="2023-08-20T18:00:00-07:00" />


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Posts",
      "item": "https://www.rfxsoftware.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "",
      "item": "https://www.rfxsoftware.com/posts/webrtc-xc/"
    }, 
    {
      "@type": "ListItem",
      "position":  4 ,
      "name": "Building WebRTC for iOS/macOS with Xcode",
      "item": "https://www.rfxsoftware.com/posts/webrtc-xc/main/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Building WebRTC for iOS/macOS with Xcode | iOS Engineering",
  "name": "Building WebRTC for iOS\/macOS with Xcode",
  "description": "Introduction WebRTC (Web Real-Time Communication) is a powerful open-source technology that enables real-time communication capabilities in web and mobile applications. While WebRTC is well-supported in web browsers, incorporating it into iOS applications often requires (re)building a binary framework to ensure seamless integration and improved performance. In this article, we will provide a comprehensive step-by-step guide on how to integrate WebRTC into any iOS/macOS application and building it from source entirely in Xcode.",
  "keywords": [
    "WebRTC", "Xcode"
  ],
  "wordCount" : "1448",
  "inLanguage": "en",
  "datePublished": "2023-08-20T18:00:00-07:00",
  "dateModified": "2023-08-20T18:00:00-07:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://www.rfxsoftware.com/posts/webrtc-xc/main/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "iOS Engineering",
    "logo": {
      "@type": "ImageObject",
      "url": "https://www.rfxsoftware.com/favicon.ico"
    }
  }
}
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3910106600267992"
    crossorigin="anonymous"></script>

<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary-bg: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list-page {
                background: var(--theme);
            }

            .list-page:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list-page:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

</head>

<body class=" type-posts kind-page layout-" id="top"><script data-no-instant>
function switchTheme(theme) {
  switch (theme) {
    case 'light':
      document.body.classList.remove('dark');
      break;
    case 'dark':
      document.body.classList.add('dark');
      break;
    
    default:
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
      }
  }
}

function isDarkTheme() {
  return document.body.className.includes("dark");
}

function getPrefTheme() {
  return localStorage.getItem("pref-theme");
}

function setPrefTheme(theme) {
  switchTheme(theme)
  localStorage.setItem("pref-theme", theme);
}

const toggleThemeCallbacks = {}
toggleThemeCallbacks['main'] = (isDark) => {
  
  if (isDark) {
    setPrefTheme('light');
  } else {
    setPrefTheme('dark');
  }
}




window.addEventListener('toggle-theme', function() {
  
  const isDark = isDarkTheme()
  for (const key in toggleThemeCallbacks) {
    toggleThemeCallbacks[key](isDark)
  }
});


function toggleThemeListener() {
  
  window.dispatchEvent(new CustomEvent('toggle-theme'));
}

</script>
<script>
  
  (function() {
    const defaultTheme = 'auto';
    const prefTheme = getPrefTheme();
    const theme = prefTheme ? prefTheme : defaultTheme;

    switchTheme(theme);
  })();
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://www.rfxsoftware.com" accesskey="h" title="iOS Engineering (Alt + H)">iOS Engineering</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main post">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://www.rfxsoftware.com">Home</a>&nbsp;»&nbsp;<a href="https://www.rfxsoftware.com/posts/">Posts</a>&nbsp;»&nbsp;<a href="https://www.rfxsoftware.com/posts/webrtc-xc/"></a></div><h1 class="post-title">Building WebRTC for iOS/macOS with Xcode</h1>
    <div class="post-meta"><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar" style="user-select: text;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" style="user-select: text;"></rect><line x1="16" y1="2" x2="16" y2="6" style="user-select: text;"></line><line x1="8" y1="2" x2="8" y2="6" style="user-select: text;"></line><line x1="3" y1="10" x2="21" y2="10" style="user-select: text;"></line></svg>
  <span>August 20, 2023</span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon" style="user-select: text;"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" style="user-select: text;"></path><line x1="7" y1="7" x2="7" y2="7" style="user-select: text;"></line></svg>
  <span class="post-tags"><a href="https://www.rfxsoftware.com/tags/webrtc/">WebRTC</a><a href="https://www.rfxsoftware.com/tags/xcode/">Xcode</a></span></span><span class="meta-item">
  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><circle cx="12" cy="12" r="9"></circle><polyline points="12 7 12 12 15 15"></polyline></svg>
  <span>7 min</span></span>

      
      
    </div>
  </header> <div class="toc side left">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#motivation" aria-label="Motivation">Motivation</a></li>
                <li>
                    <a href="#creating-an-xcode-project-for-webrtc" aria-label="Creating an Xcode project for WebRTC">Creating an Xcode project for WebRTC</a><ul>
                        
                <li>
                    <a href="#obtaining-the-sources" aria-label="Obtaining the sources">Obtaining the sources</a></li>
                <li>
                    <a href="#creating-the-targets" aria-label="Creating the targets">Creating the targets</a><ul>
                        
                <li>
                    <a href="#corertc" aria-label="CoreRTC">CoreRTC</a></li>
                <li>
                    <a href="#libwebrtc" aria-label="libWebRTC">libWebRTC</a></li>
                <li>
                    <a href="#webrtc" aria-label="WebRTC">WebRTC</a></li>
                <li>
                    <a href="#defines" aria-label="Defines">Defines</a></li>
                <li>
                    <a href="#generated-files" aria-label="Generated Files">Generated Files</a><ul>
                        
                <li>
                    <a href="#protobufs" aria-label="Protobufs">Protobufs</a></li>
                <li>
                    <a href="#registered-field-trials" aria-label="Registered Field Trials">Registered Field Trials</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#third-party-dependencies" aria-label="Third Party Dependencies">Third Party Dependencies</a></li></ul>
                </li>
                <li>
                    <a href="#build-issues" aria-label="Build issues">Build issues</a></li>
                <li>
                    <a href="#build-performance" aria-label="Build performance">Build performance</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">¶</a></h2>
<p>WebRTC (Web Real-Time Communication) is a powerful open-source technology that enables real-time communication capabilities in web and mobile applications. While WebRTC is well-supported in web browsers, incorporating it into iOS applications often requires (re)building a binary framework to ensure seamless integration and improved performance. In this article, we will provide a comprehensive step-by-step guide on how to integrate WebRTC into any iOS/macOS application and building it from source entirely in Xcode.</p>
<p>Wait! What? Why?</p>
<p>But one can build this easily as a framework with Google&rsquo;s depot tools, you might say. That is entirely correct. It might even be more convenient to run someone&rsquo;s clever build script, grab your favorite (non)cafeinated drink and voila. But what if maybe there&rsquo;s another way?</p>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3910106600267992"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-3910106600267992"
     data-ad-slot="8570155625"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2 id="motivation">Motivation<a hidden class="anchor" aria-hidden="true" href="#motivation">¶</a></h2>
<p>The main motiviation for this endeavor is to create the ability for developers to not only live-debug into the framework with familiar tools (Xcode, Instruments) but to also build a greater variety of targets. This then opens up a lot more opportunities to optimize and modernize some parts of WebRTC for iOS. With Swift-C++ interopability coming with the Swift 5.9 toolchain, some very interesting engineering might happen that could yield benefits not only for Apple platforms. Let&rsquo;s get started.</p>
<h2 id="creating-an-xcode-project-for-webrtc">Creating an Xcode project for WebRTC<a hidden class="anchor" aria-hidden="true" href="#creating-an-xcode-project-for-webrtc">¶</a></h2>
<p>A basic familiarity with Xcode and how to create projects, targets and their basic configuration is assumed.</p>
<p>The final product is available in <a href="https://github.com/ronnyf/WebRTC.git" target="_blank" rel="noopener">this github respsitory</a></p>
<h3 id="obtaining-the-sources">Obtaining the sources<a hidden class="anchor" aria-hidden="true" href="#obtaining-the-sources">¶</a></h3>
<p>Refer to <a href="https://webrtc.github.io/webrtc-org/native-code/ios/" title="Google&#39;s instructions" target="_blank" rel="noopener">Google&rsquo;s instructions</a> for fetching the WebRTC sources. At the time of writing this, the full sync would take around <strong>20 GB</strong> of disk space. In contrast, the &ldquo;Built-With-Xcode&rdquo; variant occupies <strong>788 MB</strong>.</p>
<h3 id="creating-the-targets">Creating the targets<a hidden class="anchor" aria-hidden="true" href="#creating-the-targets">¶</a></h3>
<p>While Google&rsquo;s build configuration defines several dozens of individual targets that are very neatly organized into an efficient dependency graph, this is not something that is going to be replicated for the Xcode build. The build graph is something that Xcode manages internally. Rather than taking on those responsibilities manually, Xcode is entrusted with this. Please refer to the paragraph about <a href="#build-performance">build performance</a> for a breakdown of build times of Xcode and Ninja.</p>
<p>The targets that are being created are the following:</p>
<ul>
<li>WebRTC (framework)</li>
<li>libWebRTC (static library)</li>
<li>CoreRTC (static library)</li>
</ul>
<h4 id="corertc">CoreRTC<a hidden class="anchor" aria-hidden="true" href="#corertc">¶</a></h4>
<p>The <em>CoreRTC</em> static library will contain all objects (minus the unit tests and mock objects) from the following folders:</p>
<ul>
<li>api</li>
<li>audio</li>
<li>call</li>
<li>common_audio</li>
<li>common_video</li>
<li>logging</li>
<li>media</li>
<li>modules</li>
<li>net</li>
<li>p2p</li>
<li>pc</li>
<li>resources</li>
<li>rtc_base</li>
<li>rtc_tools</li>
<li>stats</li>
<li>system_wrappers</li>
<li>test</li>
<li>testing</li>
<li>third_party*</li>
<li>video</li>
</ul>
<p><a href="/posts/webrtc-xc/webrtc-core-sources/">All Source Files</a></p>
<p>Google engineers follow the pattern of storing header files near the location of the source files and refer to them by thir relative path to the source root. There should be a name for this 🤷‍♂️.</p>
<p>Setting the <code>User Header Search Paths</code> to <code>$(SRCROOT)</code> in Xcode&rsquo;s <code>Build Settings</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nv">USER_HEADER_SEARCH_PATHS</span> <span class="o">=</span> <span class="k">$(</span>SRCROOT<span class="k">)</span></span></span></code></pre></div>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3910106600267992"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-3910106600267992"
     data-ad-slot="8570155625"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h4 id="libwebrtc">libWebRTC<a hidden class="anchor" aria-hidden="true" href="#libwebrtc">¶</a></h4>
<p>The static <code>WebRTC</code> library links the <code>CoreRTC</code> static library and builds the following sources.</p>
<p><a href="/posts/webrtc-xc/webrtc-lib-sources/">All Source Files</a></p>
<p>Additionally, the public headers need to be made available for other libraries to link this one. This is achieved with a <code>Copy Files Phase</code> where all relevent headers are copied to the <code>Products Directory</code> at subpath <code>include/WebRTC</code>.</p>
<p><a href="/posts/webrtc-xc/webrtc-lib-headers/">All Header Files</a></p>
<p>THe following SDK classes / protocols / objects were moved into the <code>modules/audio_device/ios/components/audio</code> location because the <code>audio_device_ios.h</code> header is included in <code>modules/audio_device/audio_device_impl.cc</code>. The change was introduced with <a href="https://webrtc.googlesource.com/src/&#43;/8d95e3b2114e25977af93599a32b941d4e627364" target="_blank" rel="noopener">this commit</a>. While this probably made sense when using <code>Blaze/Bazel</code>. In this configuration here, the SDK libraries are linking the core library and this is a unidirectional path. In iOS SDK terms, this would be something like <code>QuartzCore</code> linking <code>UIKit</code>.</p>
<p>So this approach has to be reversed but without making code changes. This can easily be achieved by re-exporting the symbols:</p>
<ul>
<li>RTCAudioDevice</li>
<li>RTCAudioSession</li>
<li>RTCAudioSessionDelegate</li>
<li>RTCAudioSessionActivationDelegate</li>
<li>RTCAudioSessionConfiguration</li>
</ul>
<p>from <code>CoreRTC</code> in the <code>libWebRTC</code> and the <code>WebRTC (framework)</code> targets. One minor issue is that the implementation of those references SDK includes, such as <code>RTCMacros.h</code> and <code>RTCLogging.h</code>.</p>
<p>A new header is created and added to the <code>rtc_base</code> directory: <strong>rtc_export_bridge.h</strong>. The content borrows from those defines that are declared in the SDK.
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="line"><span class="ln">10</span><span class="cl">    <span class="cp">#ifndef rtc_export_bridge_h
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="cp"></span>    <span class="cp">#define rtc_export_bridge_h
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="cp">#include</span> <span class="cpf">&#34;rtc_base/system/rtc_export.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">    <span class="cp">#ifndef RTC_OBJC_TYPE
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="cp"></span>    <span class="cp">#define RTC_OBJC_TYPE(t) t
</span></span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="cp"></span>    <span class="cp">#endif
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">    <span class="cp">#ifndef RTC_OBJC_EXPORT
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="cp"></span>    <span class="cp">#define RTC_OBJC_EXPORT RTC_EXPORT
</span></span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="cp"></span>    <span class="cp">#endif
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">23</span><span class="cl">    <span class="cp">#ifndef RTC_EXTERN
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="cp"></span>    <span class="cp">#if defined(__cplusplus)
</span></span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="cp"></span>    <span class="cp">#define RTC_EXTERN extern &#34;C&#34; RTC_OBJC_EXPORT
</span></span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="cp"></span>    <span class="cp">#else
</span></span></span><span class="line"><span class="ln">27</span><span class="cl"><span class="cp"></span>    <span class="cp">#define RTC_EXTERN extern RTC_OBJC_EXPORT
</span></span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="cp"></span>    <span class="cp">#endif
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="cp"></span>    <span class="cp">#endif
</span></span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">31</span><span class="cl">    <span class="cp">#ifndef RTC_FWD_DECL_OBJC_CLASS
</span></span></span><span class="line"><span class="ln">32</span><span class="cl"><span class="cp"></span>    <span class="cp">#ifdef __OBJC__
</span></span></span><span class="line"><span class="ln">33</span><span class="cl"><span class="cp"></span>    <span class="cp">#define RTC_FWD_DECL_OBJC_CLASS(classname) @class classname
</span></span></span><span class="line"><span class="ln">34</span><span class="cl"><span class="cp"></span>    <span class="cp">#else
</span></span></span><span class="line"><span class="ln">35</span><span class="cl"><span class="cp"></span>    <span class="cp">#define RTC_FWD_DECL_OBJC_CLASS(classname) typedef struct objc_object classname
</span></span></span><span class="line"><span class="ln">36</span><span class="cl"><span class="cp"></span>    <span class="cp">#endif
</span></span></span><span class="line"><span class="ln">37</span><span class="cl"><span class="cp"></span>    <span class="cp">#endif</span></span></span></code></pre></div></p>
<p>This allows the symbols that are already annotated with <code>RTC_OBJC_EXPORT</code> do be re-exported. Another small caveat&hellip; the <code>RTCAudioDevice.h</code> header must include the newly defined <code>rtc_export_bridge.h</code> header. This include needs to be hidden from the public interface however. For that purpose, the <code>reexported</code> folder was created, containing the original header files that are part of the public API definition. The actual headers are hidden from the public interfaces of <code>libWebRTC</code> and <code>WebRTC</code>.</p>
<h4 id="webrtc">WebRTC<a hidden class="anchor" aria-hidden="true" href="#webrtc">¶</a></h4>
<p>The framework target builds a similar set of sources as the static library, the public and internal headers however are organized using Xcode&rsquo;s <code>Build Phases</code> configuration.</p>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3910106600267992"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-3910106600267992"
     data-ad-slot="8570155625"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h4 id="defines">Defines<a hidden class="anchor" aria-hidden="true" href="#defines">¶</a></h4>
<p>Looking at the <code>BUILD.gn</code> and <code>webrtc.gni</code> file(s), there are a lot of preprocessor macro definitions that seem extremely relevant. There are several options to provide those to the build system. A <code>config.h</code> file seems to be generally used for provisioning relevant macros.</p>
<p><a href="/posts/webrtc-xc/webrtc_config/">Default configuration values for iOS builds</a></p>
<p>Adding a new header file to the <code>rtc_base</code> directory: <code>rtc_base/rtc_defines.h</code>.</p>
<p><a href="/posts/webrtc-xc/webrtc_defines/">Content of <em>rtc_defines.h</em></a></p>
<p>In order to take advantage of this configuration, the header needs to be included in a lot of source files. As a rule of thumb, if a <code>#define</code> is checked, the include statement <code>#include &quot;rtc_base/rtc_defines.h&quot;</code> should be added.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="line"><span class="ln">10</span><span class="cl"><span class="cp">#ifndef COMMON_AUDIO_FIR_FILTER_AVX2_H_
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="cp">#define COMMON_AUDIO_FIR_FILTER_AVX2_H_
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="cp"></span>
</span></span><span class="line hl"><span class="ln">13</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;rtc_base/rtc_defines.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="cp"></span>
</span></span><span class="line hl"><span class="ln">15</span><span class="cl"><span class="cp">#if defined(WEBRTC_ARCH_X86_FAMILY) &amp;&amp; defined(WEBRTC_HAS_AVX2)
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stddef.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;common_audio/fir_filter.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;rtc_base/memory/aligned_malloc.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="n">namespace</span> <span class="n">webrtc</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">25</span><span class="cl">
</span></span><span class="line"><span class="ln">26</span><span class="cl"><span class="k">class</span> <span class="nl">FIRFilterAVX2</span> <span class="p">:</span> <span class="n">public</span> <span class="n">FIRFilter</span> <span class="p">{...}</span>
</span></span><span class="line"><span class="ln">27</span><span class="cl">
</span></span><span class="line"><span class="ln">28</span><span class="cl"><span class="p">}</span>  <span class="c1">// namespace webrtc
</span></span></span><span class="line"><span class="ln">29</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">30</span><span class="cl"><span class="cp">#endif </span><span class="c1">// defined(WEBRTC_ARCH_X86_FAMILY) &amp;&amp; defined(WEBRTC_HAS_AVX2)
</span></span></span><span class="line"><span class="ln">31</span><span class="cl"><span class="c1"></span><span class="cp">#endif  // COMMON_AUDIO_FIR_FILTER_AVX2_H_</span></span></span></code></pre></div>
<p>On a platform without <code>AVX2</code> support, this would be compiled into an (empty) <code>.o</code> file, which adds a small amount of overhead but should be stripped out of any optimized binary that is being distributed.</p>
<h4 id="generated-files">Generated Files<a hidden class="anchor" aria-hidden="true" href="#generated-files">¶</a></h4>
<h5 id="protobufs">Protobufs<a hidden class="anchor" aria-hidden="true" href="#protobufs">¶</a></h5>
<p>Use your favorite <code>protoc</code> build, or try out <a href="https://github.com/ronnyf/protobuf/tree/release/webrtc" target="_blank" rel="noopener">this one</a> that is part of WebRTC&rsquo;s dependency list. Executable <code>protoc</code> binaries can be built with SwiftPM for iOS/macOS on arm64/x86_64.</p>
<h5 id="registered-field-trials">Registered Field Trials<a hidden class="anchor" aria-hidden="true" href="#registered-field-trials">¶</a></h5>
<p>The <code>registered_field_trials.h</code> file is generated by a script during Google&rsquo;s build process. Depending on the user&rsquo;s needs, the individual variants could be added manually to Xcode.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-objective-c" data-lang="objective-c"><span class="line"><span class="ln">10</span><span class="cl"><span class="c1">// This file was automatically generated. Do not edit.
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="cp">#ifndef GEN_REGISTERED_FIELD_TRIALS_H_
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="cp">#define GEN_REGISTERED_FIELD_TRIALS_H_
</span></span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;absl/strings/string_view.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="n">namespace</span> <span class="n">webrtc</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="kr">inline</span> <span class="n">constexpr</span> <span class="n">absl</span><span class="o">::</span><span class="n">string_view</span> <span class="n">kRegisteredFieldTrials</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl">    <span class="s">&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl">
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="p">}</span>  <span class="c1">// namespace webrtc
</span></span></span><span class="line"><span class="ln">24</span><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="ln">25</span><span class="cl"><span class="cp">#endif  </span><span class="c1">// GEN_REGISTERED_FIELD_TRIALS_H_
</span></span></span></code></pre></div><p>For that purpose, a dedicated <code>generated</code> folder is created and relevant headers / sources are copied into it.</p>
<h3 id="third-party-dependencies">Third Party Dependencies<a hidden class="anchor" aria-hidden="true" href="#third-party-dependencies">¶</a></h3>
<p>The following repositories were forked from their origin and a <code>Package.swift</code> file was added to allow building static and dynamic libraries with Xcode / SwiftPM. The branch <code>release/webrtc</code> has been created where the package definiton is available and also potential (required/useful) changes were made.</p>
<ul>
<li>
<p><a href="/posts/webrtc-xc/webrtc-dep-absl/">Abseil-C++</a></p>
</li>
<li>
<p><a href="/posts/webrtc-xc/webrtc-dep-crc32c/">CRC32c</a></p>
</li>
<li>
<p><a href="/posts/webrtc-xc/webrtc-dep-boringssl/">BoringSSL</a></p>
</li>
<li>
<p><a href="/posts/webrtc-xc/webrtc-dep-jsoncpp/">JSONcpp</a></p>
</li>
<li>
<p><a href="/posts/webrtc-xc/webrtc-dep-libsrtp/">libSRTP</a></p>
</li>
<li>
<p><a href="/posts/webrtc-xc/webrtc-dep-libvpx/">libVPX</a></p>
</li>
<li>
<p><a href="/posts/webrtc-xc/webrtc-dep-libyuv/">libYuv</a></p>
</li>
<li>
<p><a href="/posts/webrtc-xc/webrtc-dep-libopus/">OPUS</a></p>
</li>
<li>
<p><a href="/posts/webrtc-xc/webrtc-dep-protobuf/">Protobuf</a></p>
</li>
<li>
<p><a href="/posts/webrtc-xc/webrtc-dep-rnnoise/">RNNoise</a></p>
</li>
<li>
<p><a href="/posts/webrtc-xc/webrtc-dep-utf8range/">utf8_range</a></p>
</li>
</ul>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3910106600267992"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-3910106600267992"
     data-ad-slot="8570155625"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<h2 id="build-issues">Build issues<a hidden class="anchor" aria-hidden="true" href="#build-issues">¶</a></h2>
<p>Not considering implicit <code>int32</code> to <code>int64</code> conversions, Xcode has revealed a small <a href="/posts/webrtc-xc/webrtc-issues/">list of warnings</a></p>
<h2 id="build-performance">Build performance<a hidden class="anchor" aria-hidden="true" href="#build-performance">¶</a></h2>
<p>All measurements were taken on a 2021 16&quot; MacBook Pro M1-Max running macOS Ventura 13.4.1 (c), build: 22F770820d</p>
<p>The WebRTC framework build with <code>Ninja</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="ln">10</span><span class="cl">time ninja -C out/ios_64 framework_objc
</span></span><span class="line"><span class="ln">11</span><span class="cl">ninja: Entering directory `out/ios_64&#39;
</span></span><span class="line"><span class="ln">12</span><span class="cl">[3640/3640] STAMP obj/sdk/framework_objc.stamp
</span></span><span class="line"><span class="ln">13</span><span class="cl">ninja -C out/ios_64 framework_objc  892.88s user 189.84s system 623% cpu 2:53.54 total
</span></span></code></pre></div><p>Three Xcode builds using the <code>Product &gt; Perform Action &gt; Build with Timing Summary</code> were done with the following results:</p>
<p>1: Build succeeded    7/26/23, 10:40 AM    <code>171.6 seconds</code></p>
<p>2: Build succeeded    7/26/23, 10:43 AM    <code>192.5 seconds</code></p>
<p>3: Build succeeded    7/26/23, 11:00 AM    <code>187.9 seconds</code></p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">¶</a></h2>
<p>Judging from those preliminary (and unarguably unverified) results, the following allegations are made:</p>
<ul>
<li>The Xcode build of the WebRTC iOS framework (arm64 target) using the methods described in this article is performed in similar time compared to the <code>Ninja</code> build, <a href="https://webrtc.github.io/webrtc-org/native-code/ios/" target="_blank" rel="noopener">described by Google</a>.</li>
<li>The build graph created by <code>xcodebuild</code> is <strong>NOT</strong> less efficient than the (allegedly) manually created and highly optimized build graph produced by Google&rsquo;s <code>Bazel/Blaze</code> toolchain.</li>
<li>The complexity of managing all files in the build targets is significantly lower (lower is better) with Xcode.</li>
<li>There are no performance concerns managing several thousand source and header files with Xcode, when run on an APFS file system on a current generation SSD drive. It is reasonable to assume that the same statement would not apply when the Xcode project file is located in a user space mounted network file system.</li>
</ul>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3910106600267992"
     crossorigin="anonymous"></script>
<ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-3910106600267992"
     data-ad-slot="8570155625"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>


  </div>

  <footer class="post-footer">

  </footer>
    <div class="comments-separator"></div>
</article>
    </main>
    
<footer class="footer">
  <span>&copy; 2023 <a href="https://www.rfxsoftware.com">iOS Engineering</a></span><span style="display: inline-block; margin-left: 1em;">
    <a href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA</a>
  </span>
  <span style="display: inline-block; margin-left: 1em;">
    Powered by
    <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
    <a href="https://github.com/reorx/hugo-PaperModX/" rel="noopener" target="_blank">PaperModX</a>
  </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
    <path d="M12 6H0l6-6z" />
  </svg>
</a>

<script>
  (function() {
     
    const disableThemeToggle = '' == '1';
    if (disableThemeToggle) {
      return;
    }

    let button = document.getElementById("theme-toggle")
    
    button.removeEventListener('click', toggleThemeListener)
    
    button.addEventListener('click', toggleThemeListener)
  })();
</script>

<script>
  (function () {
    let menu = document.getElementById('menu')
    if (menu) {
      menu.scrollLeft = localStorage.getItem("menu-scroll-position");
      menu.onscroll = function () {
        localStorage.setItem("menu-scroll-position", menu.scrollLeft);
      }
    }

    const disableSmoothScroll = '' == '1';
    const enableInstantClick = '' == '1';
    
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches || disableSmoothScroll || enableInstantClick) {
      return;
    }
    
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener("click", function (e) {
        e.preventDefault();
        var id = this.getAttribute("href").substr(1);
        document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
          behavior: "smooth"
        });
        if (id === "top") {
          history.replaceState(null, null, " ");
        } else {
          history.pushState(null, null, `#${id}`);
        }
      });
    });
  })();
</script>
<script>
  var mybutton = document.getElementById("top-link");
  window.onscroll = function () {
    if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
      mybutton.style.visibility = "visible";
      mybutton.style.opacity = "1";
    } else {
      mybutton.style.visibility = "hidden";
      mybutton.style.opacity = "0";
    }
  };
</script>
<script>
  if (window.scrollListeners) {
    
    for (const listener of scrollListeners) {
      window.removeEventListener('scroll', listener)
    }
  }
  window.scrollListeners = []
</script>



<script src="/js/medium-zoom.min.js" data-no-instant
></script>




<script>
  
  
  (function() {
    const enableTocScroll = '1' == '1'
    if (!enableTocScroll) {
      return
    }
    if (!document.querySelector('.toc')) {
      console.log('no toc found, ignore toc scroll')
      return
    }
    

    
    const scrollListeners = window.scrollListeners
    const headings = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id]');
    const activeClass = 'active';

    
    let activeHeading = headings[0];
    getLinkByHeading(activeHeading).classList.add(activeClass);

    const onScroll = () => {
      const passedHeadings = [];
      for (const h of headings) {
        
        if (getOffsetTop(h) < 5) {
          passedHeadings.push(h)
        } else {
          break;
        }
      }
      if (passedHeadings.length > 0) {
        newActiveHeading = passedHeadings[passedHeadings.length - 1];
      } else {
        newActiveHeading = headings[0];
      }
      if (activeHeading != newActiveHeading) {
        getLinkByHeading(activeHeading).classList.remove(activeClass);
        activeHeading = newActiveHeading;
        getLinkByHeading(activeHeading).classList.add(activeClass);
      }
    }

    let timer = null;
    const scrollListener = () => {
      if (timer !== null) {
        clearTimeout(timer)
      }
      timer = setTimeout(onScroll, 50)
    }
    window.addEventListener('scroll', scrollListener, false);
    scrollListeners.push(scrollListener)

    function getLinkByHeading(heading) {
      const id = encodeURI(heading.getAttribute('id')).toLowerCase();
      return document.querySelector(`.toc ul li a[href="#${id}"]`);
    }

    function getOffsetTop(heading) {
      if (!heading.getClientRects().length) {
        return 0;
      }
      let rect = heading.getBoundingClientRect();
      return rect.top
    }
  })();
  </script>

</body>

</html>
